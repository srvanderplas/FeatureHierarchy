source("./Code/MixtureLineups.R")
source("./Code/theme_lineup.R")
library(ggplot2)
library(plyr)
library(dplyr)
library(reshape2)
library(nullabor)
library(doMC)
registerDoMC(12)
library(digest)
library(Cairo)

# Define colors and shapes
colors <-  c("#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", 
             "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf")

shapes <- c(1,0,3,4,8,5,2,6,-0x25C1, -0x25B7)

colortm <- read.csv("./Data/color-perceptual-kernel.csv")
# colortm[3,4] <- 0
# colortm[4,3] <- 0
colortm[8,] <- 0
colortm[,8] <- 0

shapetm <- read.csv("./Data/shape-perceptual-kernel.csv")
# shapetm[9:10,] <- 0
# shapetm[, 9:10] <- 0
shapetm[9,] <- 0
shapetm[,9] <- 0
shapetm[10,] <- 0
shapetm[,10] <- 0

# function to create a list of chosen aesthetics
get.aes <- function(r){
  c("Color", "Shape")[which(as.logical(r[1:2]))]
}

# function to create a list of chosen statistics
get.stats <- function(r){
  c("Reg. Line", "Error Bands", "Ellipses")[which(as.logical(r[3:5]))]
}
 
# load("./Data/SimulationResults.Rdata")
# sim.quantile <- function(x){
#   df <- subset(simulation.results, sd.trend==x$sd.trend & sd.cluster==x$sd.cluster & K==x$K & N ==x$N)
#   if(nrow(df)==0){
#     warning(sprintf("Parameter Set (K=%s, SD_T=%.2f, SD_C=%.2f) not found", x$K, x$sd.trend, x$sd.cluster))
#     return(data.frame(line=NA, cluster=NA, null.line=NA, null.cluster=NA))
#   } 
#   data.frame(
#     line=sum(x$line>=df$line)/length(df$line),
#     cluster=sum(x$cluster>=df$cluster)/length(df$cluster),
#     null.line=sum(x$null.line>=df$null.line)/length(df$null.line),
#     null.cluster=sum(x$null.cluster>=df$null.cluster)/length(df$null.cluster)
#     )
# }
# 
# 
# # Lineup Design
# data.parms.full <- expand.grid(K=c(3, 5),
#                           sd.trend=round(c(.25, .35, .45), 2),
#                           sd.cluster=1:3)
# data.parms.full$sd.cluster[data.parms.full$K==5] <- c(.2, .25, .3)[data.parms.full$sd.cluster[data.parms.full$K==5]]
# data.parms.full$sd.cluster[data.parms.full$K==3] <- c(.25, .3, .35)[data.parms.full$sd.cluster[data.parms.full$K==3]]
# data.parms.full$sd.cluster <- round(data.parms.full$sd.cluster, 2)
# data.parms.full$N <- 15*data.parms.full$K
# 
# plot.parms <- expand.grid(
#   color = c(0,1),
#   shape = c(0,1),
#   reg = c(0,1),
#   err = c(0,1),
#   ell = c(0,1)
# )[c(
#   1, # control
#   2, # color
#   3, # shape
#   4, # color + shape
#   18, # color + ellipse
#   20, # color + shape + ellipse
#   5, # trend
#   13, # trend + error
#   6, # color + trend
#   30 # color + ellipse + trend + error
# ),]
# 
# set.seed(518290387)
# 
# res <- llply(1:nrow(data.parms.full), function(i){
#   z <- eval.data.quantiles(i, data.parms.full[i,])
#   return(z)
# }, .parallel=T)
# 
# 
# data <- data.frame()
# data.parms <- data.frame()
# data.stats <- data.frame()
# data.subplot.stats <- data.frame()
# data.quantiles <- data.frame()
# data.ntries <- NULL
# 
# for(i in 1:length(res)){
#   data <- rbind.fill(data, res[[i]]$data)
#   data.parms <- rbind.fill(data.parms, data.frame(set=res[[i]]$data.stats$set, data.parms.full[rep(i, nrow(res[[i]]$data.stats)),]))
#   data.stats <- rbind.fill(data.stats, res[[i]]$data.stats)
#   data.subplot.stats <- rbind.fill(data.subplot.stats, res[[i]]$data.subplot.stats)
#   data.quantiles <- rbind.fill(data.quantiles, res[[i]]$quantile.eval)
#   data.ntries <- c(data.ntries, res[[i]]$ntries)
# }
# 
# save(plot.parms, data, data.parms, data.stats, data.subplot.stats, data.quantiles, file="./Data/Lineups.Rdata")
# 
# test.data.parms <- data.frame(K=rep(3, 10),
#                               type=rep(c("trend", "cluster"), each=5),
#                               sd.trend=rep(c(.2, .25), each=5),
#                               sd.cluster=rep(c(.25, .15), each=5))
# test.data.parms$N <- 15*test.data.parms$K
# test.data.parms$set <- 1:nrow(test.data.parms)
# 
# test.data <- ldply(1:nrow(test.data.parms), function(i){ data.frame(set=i, gen.test.data(test.data.parms[i,]))}, .parallel=T)
# test.data <- merge(test.data, test.data.parms[,c("set", "type")], all.x=T, all.y=T)
# test.data.subplot.stats <- 
#   ddply(test.data, .(set, .sample), 
#         function(df){
#           reg <- lm(y~x, data=df)
#           data.frame(.sample=unique(df$.sample), 
#                      LineSig = summary(reg)$r.squared, 
#                      ClusterSig = cluster(df), 
#                      target1=unique(df$target1), 
#                      type=unique(df$type))
#         })
# test.stats <- 
#   ddply(test.data.subplot.stats, .(set), summarize, 
#     set=unique(set),
#     type = unique(type),
#     target1 = unique(target1),
#     target.sig = ifelse(unique(type)=="trend", LineSig[.sample==unique(target1)], ClusterSig[.sample==unique(target1)]),
#     null.sig = ifelse(unique(type)=="trend", max(LineSig[.sample!=unique(target1)]), max(ClusterSig[.sample!=unique(target1)])),
#     K = subset(test.data.parms, test.data.parms$set==unique(set))$K,
#     sd.trend = subset(test.data.parms, test.data.parms$set==unique(set))$sd.trend,
#     sd.cluster = subset(test.data.parms, test.data.parms$set==unique(set))$sd.cluster
#   )
# test.stats$N <- test.stats$K*15
# 
# # tmp <- melt(test.stats, id.vars=c(1:3, 6:9), variable.name="sub.type", value.name="significance")
# # qplot(data=tmp, x=significance, color=sub.type, geom="density") + facet_wrap(~type)
# 
# save(test.data.parms, test.data, test.data.subplot.stats, test.stats, file="./Data/TestLineups.Rdata")
# 
# 
# load("./Data/Lineups.Rdata")
# 
# plot.names <- c("plain","color", "shape", "colorShape", "colorEllipse", "colorShapeEllipse", "trend", "trendError", "colorTrend", "colorEllipseTrendError")
# 
# plot.opts <- data.frame(expand.grid(i=unique(data$set), j=1:10))
# 
# picture.details <- ddply(plot.opts, .(i,j), function(idx){
#   i <- idx[1,1]
#   j <- idx[1,2]
#   save.pics(subset(data, set==i), datastats=data.stats[i,], plotparms=plot.parms[j,], plotname=plot.names[j])
# }, .parallel=T)
# 
# write.csv(picture.details, "./Images/Lineups/picture-details.csv", row.names=FALSE)


load("./Data/TestLineups.Rdata")

picture.details <- ldply(unique(test.data$set), function(i){
  save.pics(df=subset(test.data, set==i), datastats=test.stats[i,], 
            plotparms=data.frame(color=0, shape=0, reg=0, err=0, ell=0), plotname="plain", testplot=T)
}, .parallel=T)

write.csv(picture.details, "./Images/Lineups/test-picture-details.csv", row.names=FALSE)

